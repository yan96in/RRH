package com.cbkj.rrh.others.utils;import java.util.Map;import android.app.Activity;import android.content.Intent;import android.view.View;import android.view.View.OnClickListener;import com.alibaba.fastjson.JSON;import com.cbkj.rrh.R;import com.cbkj.rrh.bean.UserBean;import com.cbkj.rrh.db.PreferenceUtil;import com.cbkj.rrh.main.MainActivity;import com.cbkj.rrh.main.account.model.ThirdLoginParam;import com.cbkj.rrh.main.help.IThirdActionCallback;import com.cbkj.rrh.net.http.HttpRequest;import com.cbkj.rrh.net.http.HttpRequestAsyncTask.TaskListenerWithState;import com.cbkj.rrh.net.http.HttpResponse;import com.cbkj.rrh.net.http.HttpResponse.HttpTaskState;import com.cbkj.rrh.net.http.HttpURL;import com.cbkj.rrh.net.request.UserRequest;import com.cbkj.rrh.view.BToast;import com.tencent.android.tpush.XGPushManager;import com.umeng.socialize.bean.SHARE_MEDIA;/** * @todo:第三方登录操作 * @date:2015-10-5 下午5:52:42 * @author:hg_liuzl@163.com * 支持，微信，QQ，微博 */public class ThirdLoginAction implements OnClickListener,TaskListenerWithState {		/**登录类型*/	private SocialLoginType loginType;		/**界面*/	private Activity mActivity;		/**第三方登录工具类*/	private ThirdLoginUtils thirdLogin = null;		private PreferenceUtil pUitl;		public enum SocialLoginType{		WXLoginType,		QQLoginType,		WeiboLoginType	}		public ThirdLoginAction(Activity activity,PreferenceUtil util){		this.mActivity = activity;		this.pUitl = util;		this.thirdLogin = new ThirdLoginUtils(mActivity, util);		mActivity.findViewById(R.id.iw_share_wx).setOnClickListener(this);		mActivity.findViewById(R.id.iw_share_qq).setOnClickListener(this);		mActivity.findViewById(R.id.iw_share_sina).setOnClickListener(this);	}	@Override	public void onClick(View v) {		switch (v.getId()) {		case R.id.iw_share_qq:			loginType = SocialLoginType.QQLoginType;			thirdLogin.doThirdLogin(SHARE_MEDIA.QQ, callback);			break;		case R.id.iw_share_wx:			loginType = SocialLoginType.WXLoginType;			thirdLogin.doThirdLogin(SHARE_MEDIA.WEIXIN, callback);			break;		case R.id.iw_share_sina:						loginType = SocialLoginType.WeiboLoginType;			thirdLogin.doThirdLogin(SHARE_MEDIA.SINA, callback);			break;					default:			break;		}			}		/**	 * 第三方登录的回调	 */	private IThirdActionCallback callback = new IThirdActionCallback() {		@Override		public void setInfo(Map<String, Object> map) {			if (SocialLoginType.QQLoginType == loginType) {				dealQQLogin(map);			} else if (SocialLoginType.WXLoginType == loginType) {				dealWXLogin(map);			} else if (SocialLoginType.WeiboLoginType == loginType) {				dealSinaLogin(map);			}		}		@Override		public void actionType(SHARE_MEDIA platform) {		}	};	/**	 * 	 * @todo:处理 微信登录	 * @date:2015-5-6 下午5:42:54	 * @author:hg_liuzl@163.com	 * @params:	 */	private void dealWXLogin(Map<String, Object> map) {		String openid = (String) map.get("openid");		String nickName = (String) map.get("nickname");		int gender = (Integer) map.get("sex");		String uid = (String) map.get("unionid");		String headImgUrl = (String) map.get("headimgurl");		String accessToken = "";		String signature = "";				ThirdLoginParam param = new ThirdLoginParam();		param.uid = uid;		param.openid = openid;		param.nickName = nickName;		param.setGender(String.valueOf(gender));		param.headImgUrl = headImgUrl;		param.accessToken = accessToken;		param.signature = signature;		param.setLoginType(loginType);				UserRequest.getInstance().requestThirdLogin(this,mActivity,param);	}	/**	 * 	 * @todo:处理 QQ登录	 * @date:2015-5-6 下午5:42:54	 * @author:hg_liuzl@163.com	 * @params:	 */	private void dealQQLogin(Map<String, Object> map) {		String openid = (String) map.get("openid");		String uid = (String) map.get("uid");		String nickName = (String) map.get("screen_name");		int gender = map.get("gender").equals("男") ? 1 : 0;		String headImgUrl = (String) map.get("profile_image_url");		String accessToken = (String) map.get("access_token");		String signature = "";				ThirdLoginParam param = new ThirdLoginParam();		param.uid = uid;		param.openid = openid;		param.nickName = nickName;		param.setGender(String.valueOf(gender));		param.headImgUrl = headImgUrl;		param.accessToken = accessToken;		param.signature = signature;		param.setLoginType(loginType);				UserRequest.getInstance().requestThirdLogin(this,mActivity,param);	}	/**	 * 	 * @todo:处理新浪登录	 * @date:2015-5-6 下午5:42:54	 * @author:hg_liuzl@163.com	 * @params:	 */	private void dealSinaLogin(Map<String, Object> map) {		String uid = String.valueOf(map.get("uid"));		String openid = "";		String nickName = (String) map.get("screen_name");		int gender = (Integer) map.get("gender") == 1 ? 1 : 0; // 0是女，1是男		String headImgUrl = (String) map.get("profile_image_url");		String accessToken = (String) map.get("access_token");		String signature = (String) map.get("description");				ThirdLoginParam param = new ThirdLoginParam();		param.uid = uid;		param.openid = openid;		param.nickName = nickName;		param.setGender(String.valueOf(gender));		param.headImgUrl = headImgUrl;		param.accessToken = accessToken;		param.signature = signature;		param.setLoginType(loginType);				UserRequest.getInstance().requestThirdLogin(this,mActivity,param);	}	@Override	public void onTaskOver(HttpRequest request, HttpResponse response) {		if (response.getState() == HttpTaskState.STATE_OK) {			if (request.getRequestUrl() == HttpURL.URL_THIRD_LOGIN) {// 第三方登录				dealLogin(response);			}		}	}		/**	 * 	 * @todo:处理登录	 * @date:2015-5-6 上午10:04:47	 * @author:hg_liuzl@163.com	 * @params:	 */	private void dealLogin(HttpResponse response) {		if (null != response.result && response.result.getSuccess()) {			pUitl.setHasLogin(true);			UserBean ub = JSON.parseObject(response.result.getStrBody(),UserBean.class);			pUitl.setUserBean(ub);						// 注册信鸽推送,绑定推送账号			XGPushManager.registerPush(mActivity.getApplicationContext(),ub.userId);						Intent intent = new Intent(mActivity,MainActivity.class);			mActivity.startActivity(intent);			mActivity.finish();		} else {			BToast.show(mActivity, response.result.getErrorMsg());		}	}}