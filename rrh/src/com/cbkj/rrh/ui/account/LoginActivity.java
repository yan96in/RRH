package com.cbkj.rrh.ui.account;import android.app.Activity;import android.content.Intent;import android.os.Bundle;import android.text.TextUtils;import android.view.KeyEvent;import android.view.View;import android.view.View.OnClickListener;import android.widget.EditText;import com.alibaba.fastjson.JSON;import com.cbkj.rrh.R;import com.cbkj.rrh.bean.UserBean;import com.cbkj.rrh.db.PreferenceUtil;import com.cbkj.rrh.net.http.HttpRequest;import com.cbkj.rrh.net.http.HttpRequestAsyncTask.TaskListenerWithState;import com.cbkj.rrh.net.http.HttpResponse;import com.cbkj.rrh.net.http.HttpResponse.HttpTaskState;import com.cbkj.rrh.net.http.HttpURL;import com.cbkj.rrh.net.request.UserRequest;import com.cbkj.rrh.ui.IndexActivity;import com.cbkj.rrh.ui.MainActivity;import com.cbkj.rrh.ui.base.BaseBackActivity;import com.cbkj.rrh.view.BToast;import com.cbkj.rrh.view.LoadingProgress;import com.cbkj.rrh.widget.TitleBar;import com.tencent.android.tpush.XGPushManager;import com.umeng.analytics.MobclickAgent;/** * @todo:登录界面 * @author:hg_liuzl@163.com */public class LoginActivity extends BaseBackActivity implements OnClickListener,TaskListenerWithState {		public static final String TO_LOGIN_REGISTER = "islogin";		private EditText m_accountNumberEt;	private EditText m_passwordEt;	private String mAccountNumber = "";	private String mPassWord = "";	private TitleBar titleBar = null;		@Override	protected void onResume() {		super.onResume();		MobclickAgent.onResume(this);	}		@Override	protected void onPause() {		super.onPause();		MobclickAgent.onPause(this);	}		@Override	protected void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		setContentView(R.layout.layout_login_fragment);		titleBar = new TitleBar(mActivity);		titleBar.initTitleBar("登录");		initView();	}		@Override	protected void onDestroy() {		super.onDestroy();		LoadingProgress.getInstance().dismiss();	}			private void initView()	{		mAccountNumber = pUitl.getAccountNumber();		mPassWord = pUitl.getAccountPassword();				m_accountNumberEt = (EditText) findViewById(R.id.login_et_account_number);		m_accountNumberEt.setText(mAccountNumber);				m_passwordEt = (EditText) findViewById(R.id.login_et_password);		m_passwordEt.setText(mPassWord);				findViewById(R.id.tv_forget_password).setOnClickListener(this);		findViewById(R.id.login_btn_login).setOnClickListener(this);	}		@Override	public void onClick(View v) {		Intent intent = null;		switch (v.getId())		{		case R.id.btn_back:			cancelLogin();			break;		case R.id.tv_forget_password:// 忘记密码			intent = new Intent(mActivity, ForgetPasswordActivity.class);			startActivity(intent);			break;		case R.id.login_btn_login:// 登录			mAccountNumber = m_accountNumberEt.getText().toString();			mPassWord = m_passwordEt.getText().toString();			if (TextUtils.isEmpty(mAccountNumber))			{				BToast.show(mActivity, "请输入用户名");				return;			}else if(TextUtils.isEmpty(mPassWord)){				BToast.show(mActivity, "请输入密码");				return;			}else{				UserRequest.getInstance().requestLogin(this, mActivity, mAccountNumber, mPassWord);			}			break;		default:			break;		}	}	@Override	public void onTaskOver(HttpRequest request, HttpResponse response) {		if (response.getState()== HttpTaskState.STATE_OK) {			if (request.getRequestUrl() == HttpURL.URL_LOGIN) {	//登录操作				dealLogin(response);			}		}	}		/**	 * 	 * @todo:处理登录	 * @date:2015-5-6 上午10:04:47	 * @author:hg_liuzl@163.com	 * @params:	 */	private void dealLogin(HttpResponse response) {		if (null!=response.result && response.result.getSuccess()) {			pUitl.setAccountNumber(mAccountNumber);			pUitl.setAccountPassword(mPassWord);						UserBean ub = JSON.parseObject(response.result.getStrBody(), UserBean.class);			//注册信鸽推送,绑定推送账号			XGPushManager.registerPush(getApplicationContext(),ub.userId);			pUitl.setHasLogin(true);			pUitl.setUserBean(response.result.getStrBody());			pUitl.setUserID(ub.userId);						Intent i = new Intent();			i.setClass(this, MainActivity.class);			i.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);			startActivity(i);			finish();			overridePendingTransition(R.anim.slide_right_in, R.anim.slide_left_out);		}else{			BToast.show(mActivity, response.result.getErrorMsg());		}	}		@Override	public boolean onKeyDown(int keyCode, KeyEvent event) {		if (keyCode == KeyEvent.KEYCODE_BACK) {			cancelLogin();		}		return super.onKeyDown(keyCode, event);	}		/**取消登录*/	private void cancelLogin() {		setResult(RESULT_CANCELED);		finish();			}		/**	 * 退出登录操作	 * @param pUtil	 * @param mActivity	 */	  public static void quitLogin(final PreferenceUtil pUtil,final Activity mActivity) {		//注册信鸽推送,绑定推送账号		XGPushManager.unregisterPush(mActivity.getApplicationContext());		String version = pUtil.getHistoryVersion();		pUtil.doClear();		pUtil.setHistoryVersion(version);		pUtil.setShowWelcomePage(true);		Intent intent = new Intent(mActivity, IndexActivity.class);		//intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP|Intent.FLAG_ACTIVITY_NEW_TASK);    	intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);    	intent.putExtra(TO_LOGIN_REGISTER, true);    	mActivity.startActivity(intent);    	mActivity.finish();	}}